# serverless.yml
service: affordability-api-backend

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: ${env:LOCAL_API_PORT, 3000} # Uses env var, defaults to 3000

provider:
  name: aws
  runtime: nodejs20.x
  region: eu-central-1
  # iam:
  #   role:
  #     statements:
  #       - Effect: "Allow"
  #         Action: "lambda:InvokeFunction"
  #         Resource: "arn:aws:lambda:${aws:region}:${aws:accountId}:function:${self:service}-${sls:stage}-processTinkData"

  environment:
    TINK_CLIENT_ID: ${env:TINK_CLIENT_ID}
    TINK_CLIENT_SECRET: ${env:TINK_CLIENT_SECRET}
    PORTAL_HOST: ${env:PORTAL_HOST}
    JWT_SECRET: ${env:JWT_SECRET}
    JWT_EXPIRATION_TIME: ${env:JWT_EXPIRATION_TIME}
    STRIPE_SECRET_KEY: ${env:STRIPE_SECRET_KEY}
    STRIPE_WEBHOOK_SECRET: ${env:STRIPE_WEBHOOK_SECRET}

functions:
  createCheckoutSession:
    handler: handlers/stripe.createCheckoutSession
    events:
      - httpApi:
          path: /create-checkout-session
          method: post
  stripeWebhook:
    handler: handlers/stripe.stripeWebhook
    events:
      - httpApi:
          path: /stripe-webhook
          method: post
  getSubscription:
    handler: handlers/stripe.getSubscription
    events:
      - httpApi:
          path: /subscription
          method: get
  createPortalSession:
    handler: handlers/stripe.createPortalSession
    events:
      - httpApi:
          path: /create-portal-session
          method: post
  getReport:
    handler: handlers/getReport.getReport
    events:
      - httpApi:
          path: /reports/{applicantId}
          method: get
  handleTinkCallback:
    handler: handlers/handleTinkCallback.handleTinkCallback
    events:
      - httpApi:
          path: /callback/tink
          method: get
  create_check:
    handler: handlers/createCheck.createCheck
    events:
      - httpApi:
          path: /checks
          method: post
  validate_check:
    handler: handlers/validateCheck.validateCheck
    events:
      - httpApi:
          path: /checks/{token}
          method: get
  processTinkData:
    handler: handlers/processTinkData.processTinkData
  register:
    handler: handlers/auth.register
    events:
      - httpApi:
          path: /register
          method: post
  login:
    handler: handlers/auth.login
    events:
      - httpApi:
          path: /login
          method: post
  getApplicants:
    handler: handlers/getApplicants.getApplicants
    events:
      - httpApi:
          path: /applicants
          method: get